name: dunder-mifflin

services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    profiles: ["infra", "app", "e2e", "test"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./platform/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-dundermifflin} -d ${POSTGRES_DB:-dundermifflin}"
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s
    networks: [dmf]

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    restart: unless-stopped
    profiles: ["infra", "app", "e2e", "test"]
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dunder}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-mifflin}
    ports:
      - "${RABBITMQ_AMQP_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./platform/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./platform/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks: [dmf]

  openldap:
    image: osixia/openldap:1.5.0
    restart: unless-stopped
    profiles: ["infra", "app", "e2e"]
    command: ["--copy-service"]
    environment:
      LDAP_ORGANISATION: Dunder Mifflin
      LDAP_DOMAIN: dundermifflin.com
      LDAP_BASE_DN: dc=dundermifflin,dc=com
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD:-admin}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD:-admin}
      LDAP_TLS: "false"
    ports:
      - "${LDAP_PORT:-389}:389"
    volumes:
      - ldap-data:/var/lib/ldap
      - ldap-config:/etc/ldap/slapd.d
      - ./platform/ldap/users.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/50-users.ldif:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "ldapsearch -x -H ldap://127.0.0.1:389 -D \"cn=admin,dc=dundermifflin,dc=com\" -w ${LDAP_ADMIN_PASSWORD:-admin} -b \"dc=dundermifflin,dc=com\" \"(uid=jhalpert)\" dn | grep -q \"dn: uid=jhalpert,ou=people,dc=dundermifflin,dc=com\""
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks: [dmf]

  ldap-seed:
    image: osixia/openldap:1.5.0
    restart: "no"
    profiles: ["infra", "app", "e2e"]
    depends_on:
      openldap:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-ec"]
    volumes:
      - ./platform/ldap/users.ldif:/seed/users.ldif:ro
    command:
      - >
        until ldapsearch -x -H ldap://openldap:389 -D "cn=admin,dc=dundermifflin,dc=com" -w ${LDAP_ADMIN_PASSWORD:-admin} -b "dc=dundermifflin,dc=com" "(objectClass=*)" dn >/dev/null 2>&1; do sleep 2; done;
        ldapsearch -x -H ldap://openldap:389 -D "cn=admin,dc=dundermifflin,dc=com" -w ${LDAP_ADMIN_PASSWORD:-admin} -b "dc=dundermifflin,dc=com" "(uid=jhalpert)" dn | grep -q "dn: uid=jhalpert,ou=people,dc=dundermifflin,dc=com" || ldapadd -x -H ldap://openldap:389 -D "cn=admin,dc=dundermifflin,dc=com" -w ${LDAP_ADMIN_PASSWORD:-admin} -f /seed/users.ldif
    networks: [dmf]

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    restart: unless-stopped
    profiles: ["infra", "app", "e2e"]
    command: ["start-dev", "--import-realm", "--http-port=8080"]
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: ${POSTGRES_DB:-dundermifflin}
      KC_DB_SCHEMA: keycloak
      KC_DB_USERNAME: ${POSTGRES_USER:-dundermifflin}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    depends_on:
      postgres:
        condition: service_healthy
      openldap:
        condition: service_healthy
      ldap-seed:
        condition: service_completed_successfully
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    volumes:
      - keycloak-data:/opt/keycloak/data
      - ./platform/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/8080'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 35s
    networks: [dmf]

  keycloak-seed:
    image: quay.io/keycloak/keycloak:26.0
    restart: "no"
    profiles: ["infra", "app", "e2e"]
    depends_on:
      keycloak:
        condition: service_healthy
      ldap-seed:
        condition: service_completed_successfully
    entrypoint: ["/bin/sh", "/seed/seed_keycloak_ldap.sh"]
    volumes:
      - ./platform/keycloak/seed_keycloak_ldap.sh:/seed/seed_keycloak_ldap.sh:ro
    networks: [dmf]

  mailhog:
    image: mailhog/mailhog:v1.0.1
    restart: unless-stopped
    profiles: ["infra", "app", "e2e"]
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    healthcheck:
      test: ["CMD", "MailHog", "-version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks: [dmf]

  gateway:
    profiles: ["app", "e2e"]
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    image: dunder/gateway:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      keycloak-seed:
        condition: service_completed_successfully
      order-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
      finance-service:
        condition: service_healthy
      wuphf-service:
        condition: service_healthy
    environment:
      SERVICE_NAME: gateway
      SERVER_PORT: 8081
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-scranton-branch}
      KEYCLOAK_INTERNAL_BASE_URL: http://keycloak:8080
      KEYCLOAK_PUBLIC_PORT: ${KEYCLOAK_PORT:-8080}
      OIDC_CLIENT_ID: dunder-mifflin-gateway
      OIDC_CLIENT_SECRET: gateway-secret-change-me
      ORDER_SERVICE_BASE_URL: http://order-service:8093
      INVENTORY_SERVICE_BASE_URL: http://inventory-service:8094
      FINANCE_SERVICE_BASE_URL: http://finance-service:8095
      WUPHF_SERVICE_BASE_URL: http://wuphf-service:8096
      PORTAL_WEB_BASE_URL: http://host.docker.internal:${PORTAL_WEB_PORT:-3000}
      INFINITY_WEB_BASE_URL: http://host.docker.internal:${INFINITY_WEB_PORT:-3001}
      ACCOUNTING_WEB_BASE_URL: http://host.docker.internal:${ACCOUNTING_WEB_PORT:-3002}
      MOBILE_WEB_ORIGINS: http://localhost:${INFINITY_WEB_PORT:-3001},http://host.docker.internal:${INFINITY_WEB_PORT:-3001},http://localhost:${ACCOUNTING_WEB_PORT:-3002},http://host.docker.internal:${ACCOUNTING_WEB_PORT:-3002},http://localhost:${WAREHOUSE_MOBILE_PORT:-3004},http://host.docker.internal:${WAREHOUSE_MOBILE_PORT:-3004}
    ports:
      - "${GATEWAY_PORT:-8081}:8081"
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://127.0.0.1:8081/actuator/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s
    networks: [dmf]

  profile-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/profile-service
      dockerfile: Dockerfile
    image: dunder/profile-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: profile-service
      SERVER_PORT: 8091
    ports:
      - "${PROFILE_SERVICE_PORT:-8091}:8091"
    networks: [dmf]

  sales-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/sales-service
      dockerfile: Dockerfile
    image: dunder/sales-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: sales-service
      SERVER_PORT: 8092
    ports:
      - "${SALES_SERVICE_PORT:-8092}:8092"
    networks: [dmf]

  order-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    image: dunder/order-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: order-service
      SERVER_PORT: 8093
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_AMQP_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dunder}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-mifflin}
      RABBITMQ_VHOST: /
      RABBITMQ_EXCHANGE: dm.domain.events
    ports:
      - "${ORDER_SERVICE_PORT:-8093}:8093"
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://127.0.0.1:8093/actuator/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s
    networks: [dmf]

  inventory-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/inventory-service
      dockerfile: Dockerfile
    image: dunder/inventory-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: inventory-service
      SERVER_PORT: 8094
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_AMQP_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dunder}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-mifflin}
      RABBITMQ_VHOST: /
      RABBITMQ_EXCHANGE: dm.domain.events
    ports:
      - "${INVENTORY_SERVICE_PORT:-8094}:8094"
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://127.0.0.1:8094/actuator/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s
    networks: [dmf]

  finance-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/finance-service
      dockerfile: Dockerfile
    image: dunder/finance-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: finance-service
      SERVER_PORT: 8095
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
    ports:
      - "${FINANCE_SERVICE_PORT:-8095}:8095"
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://127.0.0.1:8095/actuator/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s
    networks: [dmf]

  wuphf-service:
    profiles: ["app", "e2e"]
    build:
      context: ./services/wuphf-service
      dockerfile: Dockerfile
    image: dunder/wuphf-service:dev
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SERVICE_NAME: wuphf-service
      SERVER_PORT: 8096
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_AMQP_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dunder}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-mifflin}
      RABBITMQ_VHOST: /
      RABBITMQ_EXCHANGE: dm.domain.events
    ports:
      - "${WUPHF_SERVICE_PORT:-8096}:8096"
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://127.0.0.1:8096/actuator/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s
    networks: [dmf]

  portal-web:
    profiles: ["app", "e2e"]
    build:
      context: ./apps/portal
      dockerfile: Dockerfile
    image: dunder/portal-web:dev
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      APP_NAME: portal-web
      APP_PORT: 3000
    ports:
      - "${PORTAL_WEB_PORT:-3000}:3000"
    networks: [dmf]

  infinity-web:
    profiles: ["app", "e2e"]
    build:
      context: ./apps/infinity
      dockerfile: Dockerfile
    image: dunder/infinity-web:dev
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      APP_NAME: infinity-web
      APP_PORT: 3001
    ports:
      - "${INFINITY_WEB_PORT:-3001}:3001"
    networks: [dmf]

  accounting-web:
    profiles: ["app", "e2e"]
    build:
      context: ./apps/accounting
      dockerfile: Dockerfile
    image: dunder/accounting-web:dev
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      APP_NAME: accounting-web
      APP_PORT: 3002
    ports:
      - "${ACCOUNTING_WEB_PORT:-3002}:3002"
    networks: [dmf]

  wuphf-widget:
    profiles: ["app", "e2e"]
    build:
      context: ./apps/wuphf-widget
      dockerfile: Dockerfile
    image: dunder/wuphf-widget:dev
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      APP_NAME: wuphf-widget
      APP_PORT: 3003
    ports:
      - "${WUPHF_WIDGET_PORT:-3003}:3003"
    networks: [dmf]

  warehouse-mobile:
    profiles: ["app", "e2e"]
    build:
      context: ./apps/warehouse-mobile
      dockerfile: Dockerfile
    image: dunder/warehouse-mobile:dev
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      APP_NAME: warehouse-mobile
      APP_PORT: 3004
      EXPO_PUBLIC_GATEWAY_BASE_URL: http://host.docker.internal:${GATEWAY_PORT:-8081}
      EXPO_PUBLIC_KEYCLOAK_BASE_URL: http://host.docker.internal:${KEYCLOAK_PORT:-8080}
      EXPO_PUBLIC_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-scranton-branch}
      EXPO_PUBLIC_KEYCLOAK_CLIENT_ID: warehouse-mobile
      EXPO_PUBLIC_E2E_MOCK_SCANNER: "true"
    ports:
      - "${WAREHOUSE_MOBILE_PORT:-3004}:3004"
    networks: [dmf]

  unit-tests:
    image: node:20-alpine
    profiles: ["test"]
    init: true
    working_dir: /workspace
    command:
      - /bin/sh
      - -lc
      - >
        corepack enable &&
        corepack prepare pnpm@10.4.0 --activate &&
        pnpm config set store-dir /pnpm-store &&
        pnpm install --no-frozen-lockfile &&
        pnpm -r --if-present test
    environment:
      CI: "true"
      PNPM_STORE_PATH: /pnpm-store
    volumes:
      - ./:/workspace
      - pnpm-store:/pnpm-store
    networks: [dmf]

  order-service-integration-tests:
    image: gradle:8.10.2-jdk21
    profiles: ["test"]
    init: true
    working_dir: /workspace/services/order-service
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    command:
      - /bin/bash
      - -lc
      - gradle --no-daemon test --tests '*integration*'
    environment:
      CI: "true"
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-dundermifflin}
      POSTGRES_USER: ${POSTGRES_USER:-dundermifflin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bears_beets_battlestar}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_AMQP_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dunder}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-mifflin}
      RABBITMQ_VHOST: /
      RABBITMQ_EXCHANGE: dm.domain.events
    volumes:
      - ./:/workspace
    networks: [dmf]

  e2e-tests:
    image: mcr.microsoft.com/playwright:v1.51.1-jammy
    profiles: ["test"]
    init: true
    working_dir: /workspace
    command:
      - /bin/bash
      - -lc
      - >
        corepack enable &&
        corepack prepare pnpm@10.4.0 --activate &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_BASE_URL}/actuator/health" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "http://host.docker.internal:${KEYCLOAK_PORT:-8080}/realms/${KEYCLOAK_REALM:-scranton-branch}/.well-known/openid-configuration" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_WAREHOUSE_BASE_URL}/" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_PORTAL_BASE_URL}/" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_INFINITY_BASE_URL}/" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_ACCOUNTING_BASE_URL}/" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        ready=0; for i in $(seq 1 90); do if curl -fsS "$${PLAYWRIGHT_WUPHF_WIDGET_BASE_URL}/wuphf-widget.js" >/dev/null 2>&1; then ready=1; break; fi; sleep 2; done; [ "$$ready" -eq 1 ] &&
        pnpm config set store-dir /pnpm-store &&
        pnpm install --no-frozen-lockfile &&
        pnpm test:e2e:smoke
    environment:
      CI: "true"
      PLAYWRIGHT_BASE_URL: http://host.docker.internal:${GATEWAY_PORT:-8081}
      PLAYWRIGHT_PORTAL_BASE_URL: http://host.docker.internal:${PORTAL_WEB_PORT:-3000}
      PLAYWRIGHT_WAREHOUSE_BASE_URL: http://host.docker.internal:${WAREHOUSE_MOBILE_PORT:-3004}
      PLAYWRIGHT_INFINITY_BASE_URL: http://host.docker.internal:${INFINITY_WEB_PORT:-3001}
      PLAYWRIGHT_ACCOUNTING_BASE_URL: http://host.docker.internal:${ACCOUNTING_WEB_PORT:-3002}
      PLAYWRIGHT_WUPHF_WIDGET_BASE_URL: http://host.docker.internal:${WUPHF_WIDGET_PORT:-3003}
    extra_hosts:
      - host.docker.internal:host-gateway
    volumes:
      - ./:/workspace
      - pnpm-store:/pnpm-store
    networks: [dmf]

volumes:
  postgres-data:
  rabbitmq-data:
  keycloak-data:
  ldap-data:
  ldap-config:
  pnpm-store:

networks:
  dmf:
    driver: bridge
